<!DOCTYPE html> 
<html> 
<head> 
	<meta charset="utf-8">
	<title>Picture This</title>

	<!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

	<style>
		.content-frame {
			padding: 0 25px;
		}
		#img-result {
			width: 100%;
		}
		ul.list.inset {
			margin: 0 0 25px 0;
		}
		#description-block {
			margin-bottom: 25px;
		}
	</style>

	<link rel="stylesheet" href="css/ratchet.css" />
	<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
	<script src="http://www.parsecdn.com/js/parse-1.1.5.min.js"></script>
	<script src="js/rachet.js"></script>

	<script type="text/javascript">
		//Global Variables
		var count=0;
		var count2=0;
		//Parse Constants
		var MenuItems;

		//Description for menu item
		var description = "";
		var ingredient = "";
		var category = "";
		var country = "";

		$(document).ready(function(){
			$("#submit").click(function(){
			document.getElementById("btn").disabled=false;	
			document.getElementById("btn2").disabled=false;	
				var url = "https://www.googleapis.com/customsearch/v1?key=AIzaSyDCrbF1xj9SY_wrjbCvJsRXyvozlOPdM9Q&cx=004374661755812987643:7r1lhezsvwy&searchType=image&q=";
				url+=document.getElementById("search").value;
				//Sending search string to Parse
				var currentSearchString = document.getElementById("search").value;
				grabDescription(currentSearchString);

				$.ajax({
						type:"GET",
						url:url,
						dataType: "json",
						success:function(data){
							document.getElementById("img-result").src = data.items[0].link;
						},
						error:function(data){
							alert("cannot search");
						}
				});
			});

			$("body").keypress(function(event){
				if(event.which == 13){
					$("#submit").click();
					return false;
				}
			});
		}); //End of Document Ready

		function grabDescription(searchstr) {
			Parse.initialize("disyUernrft5qEpSxF0Kwye2tvVrtUNpGrq3Jesc", "qArEBKrhqQDdXICMjXvcOSYHdNyHdj0gYvsFPyZY");
			window.MenuItems = Parse.Object.extend("MenuItems");
			var query = new Parse.Query(MenuItems);

			query.equalTo("Name", searchstr.toLowerCase());
			query.find({
				success: function(results) {
						for (var resultCount=0;resultCount<results.length;resultCount++){
							parseDescription(results[resultCount].get("Description"));
							count=results[resultCount].get("Likes");
							count2=results[resultCount].get("Dislikes");
							document.getElementById("counter").innerHTML = count;
							document.getElementById("counter2").innerHTML = count2;
							$("div#description-block").show();
						}

						if(results.length==0){
							//Reset fields if item not found in Parse
							resetDescription();
							$("div#description-block").show();
						}
					},
				error: function(error) {
					alert("Failed to get data from Parse");
					//Reset fields if there was an error in communicating with Parse
					resetDescription();
				}
			});
		}

		function resetDescription(){
			document.getElementById("description").innerHTML = "<b>Description: </b>" + "N/A";
			document.getElementById("ingredient").innerHTML = "<b>Main Ingredient(s): </b>" + "N/A";
			document.getElementById("category").innerHTML = "<b>Category: </b>" + "N/A";
			document.getElementById("country").innerHTML = "<b>Country of Origin: </b>" + "N/A";
		}

		function parseDescription(wholeDesc){
			var index_desc = wholeDesc.indexOf("#description#", 0);
			description = wholeDesc.substring(0, index_desc);//fetches description

			var index_ingrd = wholeDesc.indexOf("#ingredient#", index_desc);
			ingredient = wholeDesc.substring(index_desc + 13, index_ingrd);//fetches ingredient

			var index_cat = wholeDesc.indexOf("#category#", index_ingrd);
			category = wholeDesc.substring(index_ingrd + 12, index_cat);//fetches category

			var index_country = wholeDesc.indexOf("#country#", index_cat);
			country = wholeDesc.substring(index_cat + 10, index_country);//fetches country

			//Setting the descriptions
			document.getElementById("description").innerHTML = "<b>Description: </b>" + description;
			document.getElementById("ingredient").innerHTML = "<b>Main Ingredient(s): </b>" + ingredient;
			document.getElementById("category").innerHTML = "<b>Category: </b>" + category;
			document.getElementById("country").innerHTML = "<b>Country of Origin: </b>" + country;

		}

		function loadParseData(){
		count=0;
		count2=0;
		document.getElementById("counter").innerHTML = count;
		document.getElementById("counter2").innerHTML = count2;
			Parse.initialize("disyUernrft5qEpSxF0Kwye2tvVrtUNpGrq3Jesc", "qArEBKrhqQDdXICMjXvcOSYHdNyHdj0gYvsFPyZY");
			window.MenuItems = Parse.Object.extend("MenuItems");
		}
		function changeCount()
		{
			count++;
			document.getElementById("counter").innerHTML = count;

			MenuItems = Parse.Object.extend("MenuItems");
			var menuItems = new Parse.Query(MenuItems);
			var searchResult= document.getElementById("search").value.toLowerCase();

			menuItems.equalTo("Name", searchResult);

			menuItems.find({
				success: function(results) {
						for (var resultCount=0;resultCount<results.length;resultCount++){
						results[resultCount].set("Likes", count);
						results[resultCount].save();
						}
					},
				error: function(error) {
					alert("Failed to get data from Parse");
				}
			});	
		document.getElementById("btn").disabled=true;	
		document.getElementById("btn2").disabled=true;		
		}

		function changeCount2()
		{
			count2++;
			document.getElementById("counter2").innerHTML = count2;

			MenuItems = Parse.Object.extend("MenuItems");
			var menuItems = new Parse.Query(MenuItems);
			var searchResult= document.getElementById("search").value.toLowerCase();

			menuItems.equalTo("Name", searchResult);

			menuItems.find({
				success: function(results) {
						for (var resultCount=0;resultCount<results.length;resultCount++){
						results[resultCount].set("Dislikes", count2);
						results[resultCount].save();
						}
					},
				error: function(error) {
					alert("Failed to get data from Parse");
				}
			});	
		document.getElementById("btn2").disabled=true;
		document.getElementById("btn").disabled=true;		
		}

	</script>

</head>

<body onload="loadParseData()"> 
	<!-Title Bar->
	<header class="bar-title">
		<h1 class="title">Picture This</h1>
  	</header>
  	
  	<!-Footer Bar->
  	<nav class="bar-tab">
	  <ul class="tab-inner">
	    <li class="tab-item">
	      <a href="camera.html">
	        <img class="tab-icon" src="img/camera.png">
	        <div class="tab-label">Camera</div>
	      </a>
	    </li>
	    <li class="tab-item active">
	      <a href="">
	        <img class="tab-icon" src="img/search.png">
	        <div class="tab-label">Search</div>
	      </a>
	    </li>
	    <li class="tab-item">
	      <a href="">
	        <img class="tab-icon" src="img/settings.png">
	        <div class="tab-label">Settings</div>
	      </a>
	    </li>
	  </ul>
	</nav>

	<div id="home" class="content">
	<!-Slider->
	<!--
	<div class="slider">
	  <ul>
	    <li>
	      <img src="img/slide-1.jpg">
	      <span class="slide-text">‚Üê Slide me</span>
	    </li>
	    <li>
	      <img src="img/slide-2.jpg">
	    </li>
	    <li>
	      <img src="img/slide-3.jpg">
	    </li>
	  </ul>
	</div>
	-->

	<br><br>
	<div class="content-frame">
		<form class="padded">
			<input type="search" id="search" placeholder="What's on the menu?"/><br>
			<a class="button button-block" id="submit" >Search</a>
	 	</form>
	 	<br>
		<image id="img-result"/>
		<br><br>

		<div id="description-block" style="display:none;">
			<ul class="list inset" id="detail">
				<li id="description"><b>Description: </b>N/A</li>
				<li id="ingredient"><b>Main Ingredients(s): </b>N/A</li>
				<li id="category"><b>Category: </b>N/A</li>
				<li id="country"><b>Country of Origin: </b>N/A</li>
			</ul>
			<button class="button-positive" onclick="changeCount()" id="btn"> Helpful <span id="counter" class="count">N/A</span></button>
			<button class="button-negative" onclick="changeCount2()" id="btn2"> Not Helpful <span id="counter2" class="count">N/A</span></button>
		<div>
	</div>


</body>

</html>